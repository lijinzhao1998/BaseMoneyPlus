# 基金管家系统 - 使用说明

## ✨ 新功能：均线分析系统

### 功能特性

本系统现在支持完整的基金均线分析，帮助您判断买入和卖出时机：

#### 1. 多周期均线分析
- **月线 (MA20)**：约20个交易日，反映短期趋势
- **季线 (MA60)**：约60个交易日，反映中期趋势
- **年线 (MA250)**：约250个交易日，反映长期趋势
- **长期均线 (MA500)**：约500个交易日（2年），反映历史位置

#### 2. 智能买卖建议
系统会根据当前净值与各均线的偏离度，给出操作建议：
- ⭐⭐⭐ **强烈建议加仓**：基金处于历史低位
- ⭐⭐ **可以适当加仓**：基金相对低估
- ⭐ **持有观望**：基金处于合理区间
- ⚠️⚠️ **可以适当减仓**：基金相对高估
- ⚠️⚠️⚠️ **建议减仓**：基金处于历史高位

#### 3. 精确收益计算
- 支持设置**投入日期**，从实际投入时间开始计算收益
- 避免从基金成立日期计算导致的收益偏差
- 适合后期加入的投资者

#### 4. 观察基金功能
- 支持添加**未投入基金**到观察列表
- 通过均线分析判断是否到达适合买入的时机
- 不影响实际持仓的收益计算

### 使用方法

#### 方式1：配置文件方式（推荐）

1. 编辑 `holdings_config.json`：

```json
{
  "holdings": {
    "017811": {
      "name": "基金1",
      "cost_basis": 1.0,
      "amount": 10000,
      "invested": true,
      "investment_start_date": "2024-01-01"
    }
  },
  "watchlist": {
    "161725": {
      "name": "招商中证白酒",
      "invested": false,
      "watch_start_date": "2024-01-01",
      "note": "观察是否到达低点"
    }
  }
}
```

2. 运行均线分析：

```bash
py ma_analysis.py
```

#### 方式2：集成在日报中

运行主程序时，会自动包含均线分析：

```bash
py main.py
```

选择"立即运行一次"，报告中会包含完整的均线分析。

### 配置说明

#### holdings（持仓基金）
- `name`: 基金名称
- `cost_basis`: 成本净值
- `amount`: 投资金额
- `invested`: true（表示已投入）
- `investment_start_date`: 投资开始日期（重要！用于准确计算收益）

#### watchlist（观察基金）
- `name`: 基金名称
- `invested`: false（表示仅观察）
- `watch_start_date`: 开始观察日期（用于计算如果当时买入的收益）
- `note`: 备注信息

### 分析报告示例

```
============================================================
📊 招商中证白酒 (161725)
============================================================

💰 当前净值: 0.8234

📈 均线分析:
  月线(MA20):  0.8156   偏离:  +0.96%
  季线(MA60):  0.8567   偏离:  -3.89%
  年线(MA250): 0.9123   偏离:  -9.74%
  长期(MA500): 1.0234   偏离: -19.55%

🎯 位置分析:
  当前位置: low
  信号强度: 3/5
  操作建议: ⭐⭐⭐ 强烈建议加仓

  详细分析:
    • 月线下方0.96% - 短期偏低
    • 季线下方3.89% - 中期偏低
    • 年线下方9.74% - 长期偏低
    • 长期均线下方19.55% - 历史低位

💵 投资收益分析:
  投入日期: 2024-01-01
  投入时净值: 0.9500
  当前净值: 0.8234
  📉 收益率: -13.33%

数据点数: 730 | 分析时间: 2025-10-30 15:30:00
============================================================
```

## 🎯 问题解决

### 问题1：脚本运行后没有任何输出
**原因：** Windows上默认的`python`命令指向Windows Store的存根程序  
**解决方案：** 使用 `py` 命令而不是 `python` 命令

### 问题2：基金分析失败
**原因：** API返回格式从JSONP改为纯JSON，但代码只支持JSONP格式  
**解决方案：** 已修复 `fund_data.py`，现在同时支持纯JSON和JSONP两种格式

### 已修复的问题
✅ 修复了 `fund_analyzer.py` 的缩进错误（第113行）  
✅ 修复了历史数据获取失败的bug（API格式兼容性问题）  
✅ 所有基金现在都能正常分析

## 🚀 快速开始

### 1. 测试系统

```bash
py test.py
```

选择测试选项：
- 1: 测试数据获取
- 2: 测试分析器
- 3: 测试消息发送
- 4: 全部测试

### 2. 运行主程序

```bash
py main.py
```

或者直接双击 `run.bat`

选择运行模式：
- 1: 立即运行一次（生成并发送报告）
- 2: 启动定时任务（后台运行）
- 3: 退出

### 3. 配置

#### 修改持仓信息
编辑 `main.py` 中的 `holdings` 字典：

```python
self.holdings = {
    "017811": {"cost_basis": 1.0, "amount": 10000},  # 修改成本和金额
    # ... 其他基金
}
```

#### 配置消息推送（可选）

创建 `.env` 文件：

```env
# 服务器酱（微信推送）
SERVER_CHAN_KEY=your_key

# 企业微信
WECHAT_WEBHOOK=your_webhook

# 钉钉
DINGTALK_WEBHOOK=your_webhook
```

## 📝 注意事项

1. **如果没有配置推送服务**，报告仍然会生成并显示在控制台
2. **修改持仓信息**：根据你的实际持仓修改成本和金额
3. **API请求限制**：已添加延时，避免请求过快
4. **数据来源**：从公开API获取基金净值数据

## 🔧 依赖检查

所有依赖已安装完成：
- ✓ requests
- ✓ pandas
- ✓ numpy
- ✓ scikit-learn
- ✓ beautifulsoup4
- ✓ matplotlib
- ✓ schedule

## 📊 报告示例

```
📊 基金管家日报 - 2025-10-27 08:52:58
==================================================

【XXXX基金 017811】📈
  今日涨跌: +4.25%
  今日收益: +425.00元
  累计收益: +5159.00元 (+51.59%)
  当前净值: 1.5159
  趋势: 震荡整理
  预测趋势: -8.03% (未来5天平均)

【XXXX基金 002963】📉
  今日涨跌: -0.49%
  今日收益: -49.00元
  累计收益: +9974.67元 (+99.75%)
  当前净值: 2.9962
  趋势: 震荡整理
  预测趋势: +2.60% (未来5天平均)

==================================================
📊 总资产收益: +47006.17元
📈 今日总收益: +1752.00元
==================================================

⚠️ 风险提示：投资有风险，入市需谨慎
```

## ❓ 常见问题

**Q: 为什么使用 `py` 而不是 `python`？**
A: Windows上`python`命令可能指向Windows Store的存根，使用`py`启动器更可靠。

**Q: 需要配置推送才能运行吗？**
A: 不需要。推送是可选的，报告会在控制台显示。

**Q: 如何修改定时时间？**
A: 编辑 `config.py` 中的 `SCHEDULE_TIME` 变量。

**Q: 数据是实时的吗？**
A: 基金净值通常在交易日18:00后更新。

## 📞 技术支持

如有问题，请检查：
1. Python版本（推荐 3.8+）
2. 依赖是否已安装
3. 网络连接是否正常
4. 基金代码是否正确
