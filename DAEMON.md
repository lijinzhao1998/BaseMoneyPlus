# 基金管家守护进程管理

## 快速开始

### 使用命令行管理（推荐）

```bash
# 查看状态
py daemon.py status

# 启动守护进程
py daemon.py start

# 停止守护进程
py daemon.py stop

# 重启守护进程
py daemon.py restart
```

### 使用主程序管理

```bash
py main.py
```

运行后会显示守护进程状态，并提供以下选项：
1. 立即运行一次（生成并发送报告）
2. 启动/重启定时任务（后台运行）
3. 停止守护进程
4. 退出

## 功能说明

### 🔍 进程状态检测

启动时会自动检测：
- 是否已有守护进程运行中
- PID 文件是否存在
- 进程是否真正在运行

### 📝 PID 文件管理

- 文件路径：`fund_manager.pid`
- 自动创建：启动守护进程时
- 自动删除：停止守护进程时
- 自动清理：检测到僵尸进程时

### 🛡️ 安全特性

- ✅ 防止重复启动（检测到已有进程会提示）
- ✅ 优雅关闭（Ctrl+C 自动清理）
- ✅ 自动清理残留 PID 文件
- ✅ 跨平台支持（Windows/Linux/Mac）

## 示例场景

### 场景 1：查看守护进程状态

```bash
PS D:\BaseMoneyPlus> py daemon.py status
🔴 守护进程未运行
```

### 场景 2：启动守护进程

```bash
PS D:\BaseMoneyPlus> py daemon.py start
正在启动守护进程...
✅ 守护进程已启动
🟢 守护进程运行中 (PID: 12345)
```

### 场景 3：重复启动（已有进程）

```bash
PS D:\BaseMoneyPlus> py daemon.py start
❌ 守护进程已在运行 (PID: 12345)
💡 如需重启，请先使用 'py daemon.py stop' 停止
```

### 场景 4：停止守护进程

```bash
PS D:\BaseMoneyPlus> py daemon.py stop
✅ 已停止守护进程 (PID: 12345)
```

### 场景 5：重启守护进程

```bash
PS D:\BaseMoneyPlus> py daemon.py restart
正在重启守护进程...
🔴 守护进程未运行
正在启动守护进程...
✅ 守护进程已启动
🟢 守护进程运行中 (PID: 12346)
```

## 在主程序中的使用

运行 `main.py` 时，程序会自动显示守护进程状态：

```
============================================================
基金管家系统
============================================================

🟢 守护进程运行中 (PID: 12345)

选择运行模式：
1. 立即运行一次（生成并发送报告）
2. 启动/重启定时任务（后台运行）
3. 停止守护进程
4. 退出
============================================================
请输入选项 (1-4): 
```

**选项说明：**

- **选项 1**：立即生成并发送一次报告（不影响守护进程）
- **选项 2**：启动或重启守护进程（如果已运行会先停止）
- **选项 3**：停止正在运行的守护进程
- **选项 4**：退出程序

## 定时任务配置

守护进程的定时任务时间可在 `config.py` 中配置：

```python
SCHEDULE_TIME = "21:40"  # 每天21:40发送报告
```

修改后需要重启守护进程才能生效。

## 故障排除

### Q: 守护进程显示未运行，但任务管理器能看到进程？

A: 可能是 PID 文件丢失。可以先停止所有进程，然后重新启动。

```bash
py daemon.py stop
py daemon.py start
```

### Q: 如何查看守护进程的日志？

A: 查看 `fund_manager.log` 文件。

```bash
# Windows
type fund_manager.log

# Linux/Mac
cat fund_manager.log
```

### Q: 守护进程无法停止？

A: 可以手动删除 PID 文件，然后在任务管理器中结束进程。

```bash
# 删除 PID 文件
del fund_manager.pid

# Windows 任务管理器手动结束进程
```

## 注意事项

⚠️ **重要提示**

1. 守护进程需要在后台持续运行才能定时发送报告
2. 关闭终端窗口不会自动停止守护进程
3. 需要停止时请使用 `py daemon.py stop` 命令
4. 建议将程序部署在服务器上 24 小时运行
